统一异常处理

[TOC]

默认情况下，Spring Boot提供了一个/error mappging 处理所有的错误，并且它被注册为servlet容器中的"全局"错误页面。

对于机器客户端，它会产生Http状态和json的错误消息。对于浏览器客户端，有一个 "whiteLabel"错误视图，以HTML格式呈现相同的数据。



server.error 里面有很多属性，可以自定义默认的错误处理行为





我们可以如下自定义异常处理，默认是全局的，也可以仅仅对指定的包做处理


```java
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(Exception.class)
    ResponseEntity<Result<?>> exceptionHandler(HttpServletRequest request, Throwable ex) {
        log.error("global Throwable handle: ", ex);
        HttpStatus status = getStatus(request);
        return new ResponseEntity<>(Result.build(status.value(), ex.getMessage()), status);
    }

    /**
     * controller层参数校验
     *
     * @param request  HttpServletRequest
     * @param ex       MethodArgumentNotValidException
     * @return         ResponseEntity
     */
    @ExceptionHandler(value = MethodArgumentNotValidException.class)
    ResponseEntity<Result<?>> exceptionHandler(HttpServletRequest request, MethodArgumentNotValidException ex) {
        log.error("global MethodArgumentNotValidException handle:", ex);
        StringBuilder builder = new StringBuilder();
        for (ObjectError allError : ex.getBindingResult().getAllErrors()) {
            builder.append(allError.getDefaultMessage()).append(" ");
        }
        Result<Object> result = Result.build(PARAM_ERROR.getCode(), builder.toString());
        return new ResponseEntity<>(result, getStatus(request));
    }

    /**
     * service层参数校验
     *
     * @param request  HttpServletRequest
     * @param ex       ConstraintViolationException
     * @return         ResponseEntity
     */
    @ExceptionHandler(value = ConstraintViolationException.class)
    ResponseEntity<Result<?>> exceptionHandler(HttpServletRequest request, ConstraintViolationException ex) {
        log.error("global MethodArgumentNotValidException handle:", ex);
        Result<Object> result = Result.build(PARAM_ERROR.getCode(), ex.getMessage());
        return new ResponseEntity<>(result, getStatus(request));
    }

    private HttpStatus getStatus(HttpServletRequest request) {
        Integer statusCode = (Integer) request.getAttribute("javax.servlet.error.status_code");
        return Optional.ofNullable(statusCode).map(HttpStatus::valueOf).orElse(INTERNAL_SERVER_ERROR);
    }

}

```

